# Lab3

## Lab

### Lab_03-1.malware

1. Did you find any interesting resources? If so, how did you extract them?
   1. I was able to extract a DLL by loading the PE into Resource Hacker
2. List at least 3 imports or sets of imports. What do they do? How might a piece of malware use them?
   1. IsDebuggerPresent - used to check if a process is being debugged, useful to see if the malware is being analyzed
   2. LoadResource - used to load DLL/external resource, useful to load a malicious DLL
   3. system - used to execute bash commands, useful for executing malicious commands
3. List at least 3 strings that stick out to you and how they might relate to malware activity
   1. IDR_DLL1 - may be referencing a malicious DLL which will be loaded
   2. https://security.cs.rpi.edu/courses/binexp-spring2015/ - may be connecting to this URL
   3. https://rpis.ec/ - may be connecting to this URL to exfiltrate data
4. What persistence mechanism does this malware use? What host based signatures can you gather from this?
   1. This unpacks a DLL, then sets a registry key to execute this DLL
5. What is the CLSID served by this malware
   1. CLSID\\\\{3543619C-D563-43f7-95EA-4DA7E1CC396A} (written to the registry)
   2. Two other GUIDs are used in the DLL

1. What is the name of the COM interface that this malware makes use of
   1. IWebBrowser2
2. What two COM functions does this malware call from the COM interface, and what are they used for? (check the PMA book)
   1. 0x2c
   2. 0xa4 (not sure how we were supposed to find the map of offsets to functions though)



### Lab_03-2.malware

#### Basic Analysis

1. What is the md5 hash? What does VirusTotal report?
   1. md5: bf4f5b4ff7ed9c7275496c07f9836028
   2. This malware connects to several domains (us.t28.net/t28.net) as well as several IP addresses (most are local IP addresses within the 192.168.122.* subnet, but also to 72.52.179.175)
   3. The local IPs the malware connects to are attempting to contact "tom-PC"
   4. This malware opens C:\DOCUMEN~1\Administrator\java.exe, and also writes to this file (likely droping new malware), and also writes to C:\Users\Administrator\java.exe
   5. This malware sets a series of registry keys, likely as a persistence mechanism
   6. This malware executes the following shell commands
      1. `wmiadap.exe /F /T /R`
      2. `C:\Windows\system32\wbem\wmiprvse.exe -Embedding`
2. Name 3 imports/sets of imports you haven't seen before, and describe what they do/how it may be used by the malware
   1. RegCloseKey/RegOpenKeyA/RegSetValueExA - close/open/edit a registry key, which may be useful as a persistence mechanism for the malware
   2. WinExec - executes a command. This may be used to execute the malicous "java" we saw from VirusTotal
   3. CreateProcessA/CreatePipe/PeekNamedPipe - creates a new process (useful for launching a new process with the malicious code), then creates a pipe an allows the parent process to communicate with the child process
3. List at least 3 strings that stick out and describe how they might relate to malicious activity
   1. "SOFTWARE\\Microsoft\\Windows\CurrentVersion\\Run" - looks like a registry key, likely one which specifies programs to automatically run at boot
   2. "\\java.exe" - lines up with the "java" file written to disk, likely hosting malicious code
   3. "cmd.exe" - the command prompt executable, may be used with WinExec to execute commands in the command prompt
4. What persistence mechanism is used by this malware? What host based signatures may be used
   1. This malware writes a "java.exe" file to several locations on disk, and then modifies several registry keys to point to this file to cause it to run automatically at start
      1. C:\Users\Administrator\java.exe
      2. C:\DOCUMEN~1\Administrator\java.exe
      3. HKEY_LOVAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\sysinfo -> C:\DOCUME~1\Administrator\java.exe

#### Advanced Analysis

1. What address corresponds to the function which lists processes? What is the corresponding command ID? What information is exfiltrated? What Windows API calls are made?
   1. 0x00402310
   2. Listing processes corresponds to command 7
   3. A list of processes is sent to the established socket
   4. CreateToolhelp32Snapshot, Process32First, Process32Next
2. What address corresponds to the function which connects to a remote shell? What is the corresponding command ID? What information is exfiltrated? What Windows API calls are made?
   1. 0x00402490
   2. Connecting to a remote shell corresponds to command 9
   3. The output of the command that's executed is read from a pipe and sent to the remote server
   4. CreatePipe, CreateProcessA, Sleep, PeekNamedPipe, ReadFile
3. What address corresponds to the function which uploads files? What is the corresponding command ID? What information is exfiltrated? What Windows API calls are made?
   1. 0x00402210
   2. Command 6
   3. The file contents and size are sent to the remote server
   4. CreateFileA, CreateFileMappingA, CloseHandle, MapViewOfFile, GetFileSize, UnmapViewOfFile
4. Name 3 additional functionalities of this malware
   1. Run a command with WinExec
   2. Delete a file from the host machine
   3. Download a file to the infected machine

## Updates

While the lecture slides cover _some_ of the necessary information for this lab, they should be updated to cover more material. Ie:

1. Should discuss mechanisms for detecting/extracting DLLs
2. There is only a single slide on COM, which doesn't go into much detail. More slides should be added to talk about specific COM functions/etc.
3. While registry keys are talked about a little, a signifigant chunk of this lab relies on understanding how they can be used for persistence. (there is a page in the textbook that has much of this information already, this should be ported to the slides)
4. The advanced analysis section assumes some RE knowledge to understand the basic workflow. Some mention of strategies should be made (ie. sorting by function size in ghidra, examining xrefs of strings/imports/etc.)
5. Was the malware updated at some point but the answer key was not? It looks like one question on the answer key is addressing a different question than the lab handout, and the CLSID in the answer key is the one being saved to the registry, not the one being used in COM



## Learning Outcomes

1. Learned more about windows internals (ie. COM interfaces, handles, advapi.dll, etc)
2. Learned about windows specific persistence mechanisms (ie. registry autorun keys, services, etc.)
3. General knowledge of windows registry



## Malicious Patterns

1. Dumping files to disk, pointing registry keys to them (can be benign as well)
2. Creating files with common names which don't match their usual content (ie. java.exe)
3. Scan all processes
4. Piping stdin/stdout to network
5. obfuscating network traffic (eg. xoring with fixed key)
6. spawning/killing processes based on network commands
7. scanning/deleting/exfiltrating files without user consent