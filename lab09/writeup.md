### Lab_09-1.malware

1. Is there a name for the packer used to protect this sample?
   1. UPX2 (from PEiD)
2. What is OEP?
   1. 0x401000
3. What method did you use to find the OEP?
   1. While I had issues finding the OEP dynamically (FLARE has Olly installed with the same plugin described in the slides, but I couldn't find a similar plugin for x64dgb), ghidra recognizes `UPX0`, `UPX1`, and `UPX2` sections. 0x401000 corresponds to the start of the first UPX packed section `UPX0`.

### Lab_09-2.malware

1. What are two indicators of this sample being packed?
   1. There is an extremely high entropy section towards the start of the file
   2. There are few imports (all of which could be used to resolve additional imports)
2. What is this program packed with?
   1. PE Detective detects the packer as `Petite 2.1`
3. What is OEP?
   1. 0x4012C0
4. What method did you use to find OEP?
   1. (followed the video here: https://www.youtube.com/watch?v=yfhcppEqbMM)
   2. Use ghidra to find the `pushad` instruction
   3. Set a breakpoint on that instruction in x64dbg
   4. Set a breakpoint that triggers on any access to the pushed address
   5. The breakpoint is triggered on the `popad` instruction
   6. Right after this `popad` instruction is a `jmp` instruction to 0x4012C0
5. Write a script to unpack this program
   1. I used Scylla to dump the process memory from the OEP
6. Remove the nag screen and enable the secret menu item, and briefly explain how you did it
   1. Reach OEP as described in step 4
   2. Use the OllyDumpEx plugin from within x64dbg to dump the process (setting OEP as the entry point)
      1. **MAKE SURE TO CHECK THE "DISABLE RELOCATION" BOX**
   3. Open the Scylla plugin
      1. Make sure the OEP matches the recovered OEP
      2. Click "IAT Autosearch" to automatically search for IAT entries in the unpacked process memory
         1. Scylla will automatically determine the location (VA = Virtual Address) and size for the IAT
      3. Click "Get Imports" to scan the detected IAT section for imports
         1. Scylla will automatically detect most, but not all of the imports
         2. There will be several errors which will pop up in the import table. For each error:
            1. Right click and disassemble it
            2. Once you know where each import points (for imports which aren't simply an unconditional jump you may need to right click targets of a conditional jump and press "follow" to find the possible resolutions), double click on the entry and select the appropriate DLL and function
      4. After fixing **all** of the errors, press the "fix dump" button, and fix the dump produced by OllyDumpEx
   4. You should now have the unpacked binary - open this up in ghidra and scan for strings (Window -> Defined Strings)
   5. Find the "&Secret" string, and change the `1` argument to `AppendMenuA` to a `0`
      1. Find the corresponding `push 0x1` instruction in ghidra, right click, and click `patch instruction`, then change the `0x1` to an `0x0`
   6. Find the "I'm stupid Nag-Screen..." string which pops up, and navigate to the xref where it's used in the same setup function as the "&Secret" string
   7. Find the function call where this string is passed, and convert the `call` instruction to a series of `nop`s
   8. Now export the file (File -> Export Program), select "Binary" as the format, and hit OK
   9. The exported file will have a `.bin` extension - convert it to a `.exe` and run it

### Lab_09-3.malware

1. How did you find OEP?
   1. I found the entrypoint 0x4012a5 by patching out the call to `GetTickCount` (to avoid issues with my debugger), and then setting a breakpoint on `pusha` instructions and watching to see when they would be popped. I eventually noticed code running at this address, and confirmed in ghidra that this address was previously uninitialized and had an xref from the code segment
2. How did you resolve any PE header corruption?
3. How did you fix the import table?



## Updates

* Most of the relevant information is only briefly covered in the last few slides, which should be fleshed out (eg. they talk about the `pusha/popa` trick, but not why that trick is used)
* A brief walkthrough should be given of using the tools to actually dump a process and recover the IAT, since we had to figure that out on our own
* Tools should be updated (eg. x64dbg instead of OllyDbg)
* The answer key doesn't include answers to several of the questions, or doesn't go into sufficient detail (eg. the third lab has no OEP given for us to check our work with)
* The second checkpoint asks us to write a custom script to unpack the malware - I don't believe this is actually necessary
* The third checkpoint is quite difficult - I feel that just the first two are sufficient 





## malicous behaviors

nulling header: 8

destroyed IAT: 8

gettickcount to detect debugger: 4

mapping rwx section and jumping to it: 3

high entropy in executable: 5



